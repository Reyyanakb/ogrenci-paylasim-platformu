@model List<mvcFinal2.Models.Message>
@{
    var receiver = ViewBag.Receiver as mvcFinal2.Models.AppUser;
    if (receiver == null) { return; }
    var currentUserId = (int)ViewBag.CurrentUserId;
    ViewData["Title"] = "Sohbet - " + receiver.FullName;
}

<div class="container section-padding">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card-custom overflow-hidden">
                <!-- Chat Header -->
                <div class="p-3 bg-light border-bottom d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                         <div class="d-inline-flex align-items-center justify-content-center bg-white border rounded-circle me-3" style="width: 45px; height: 45px;">
                            <i class="bi bi-person-fill text-warning fs-4"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-0">@receiver.FullName</h6>
                            <small class="text-muted">@receiver.University</small>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages Area -->
                <div class="p-4" style="height: 500px; overflow-y: auto; background-color: #f9f9f9; display: flex; flex-direction: column;">
                    @if (Model.Any())
                    {
                        foreach (var message in Model)
                        {
                            if (message.IsSystemMessage)
                            {
                                <div class="d-flex justify-content-center mb-3">
                                    <div class="bg-white border rounded-3 px-4 py-3 text-center text-secondary shadow-sm" style="max-width: 85%; font-size: 0.9rem;">
                                        <i class="bi bi-shield-check text-success fs-5 mb-1 d-block"></i>
                                        <strong>Sistem Mesajı</strong><br>
                                        @Html.Raw(message.Content)
                                        <div class="text-muted mt-1" style="font-size: 0.7rem;">@message.SentAt.ToString("g")</div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                var isMe = message.SenderId == currentUserId;
                                <div class="d-flex @(isMe ? "justify-content-end" : "justify-content-start") mb-3">
                                    <div style="max-width: 75%;">
                                        <div class="p-3 rounded-3 @(isMe ? "bg-primary text-dark" : "bg-white border")" 
                                             style="@(isMe ? "background-color: var(--primary-color); border-bottom-right-radius: 4px;" : "border-bottom-left-radius: 4px;") box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                            <p class="mb-1">@message.Content</p>
                                        </div>
                                        <div class="d-flex align-items-center gap-1 mt-1 @(isMe ? "justify-content-end" : "")">
                                             <small class="text-muted" style="font-size: 0.7rem;">@message.SentAt.ToString("HH:mm")</small>
                                             @if(isMe)
                                             {
                                                 <i class="bi @(message.IsRead ? "bi-check-all text-primary" : "bi-check")" style="font-size: 0.8rem;"></i>
                                             }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted my-auto">
                            <i class="bi bi-chat-dots fs-1 mb-2 d-block"></i>
                            <p>Henüz mesaj yok. İlk mesajı sen gönder!</p>
                        </div>
                    }
                </div>

                <!-- Message Input -->
                <div class="p-3 bg-white border-top">
                    <form asp-action="SendMessage" method="post" class="d-flex gap-2">
                        <input type="hidden" name="receiverId" value="@receiver.Id" />
                        <input type="text" name="content" class="form-control form-control-custom" placeholder="Mesajınızı yazın..." required autocomplete="off">
                        <button type="submit" class="btn btn-primary-custom px-4">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Scroll to bottom of chat
    var chatContainer = document.querySelector('.p-4');
    chatContainer.scrollTop = chatContainer.scrollHeight;
</script>
